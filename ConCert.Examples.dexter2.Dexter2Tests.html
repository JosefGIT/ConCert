<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<link href="coqdocjs.css" rel="stylesheet" type="text/css"/>
<link href="toc.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript" src="coqdocjs.js"></script>
</head>

<body onload="document.getElementById('content').focus()">
  <div id="header">
    <span class="left">
      <span class="modulename"> <script> document.write(document.title) </script> </span>
    </span>

    <span class="button" id="toggle-proofs"></span>

    <span class="right">
      <a href="toc.html">Table of contents</a>
      <a href="https://github.com/AU-COBRA/ConCert" target="_balnk">Project Page</a>
    </span>
</div>
  <div id="content" tabindex="-1" onblur="document.getElementById('content').focus()">
    <div id="js-toc-header" class="toc-header">Contents:</div>
    <div id="js-toc" class="toc" data-toc="h1,h2,h3,h4" data-toc-container="doc">
    </div>
    <div id="main">
<h1 class="libtitle">Library ConCert.Examples.dexter2.Dexter2Tests</h1>

<div class="code">
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Blockchain</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">BoundedN</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Containers</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Serializable</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ResultMonad</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution.Test</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">QCTest</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.Dexter2</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Dexter2CPMM</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.Dexter2</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Dexter2FA12</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.Dexter2</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Dexter2Gens</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.Dexter2</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Dexter2Printers</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.FA2</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">FA2Token</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples.FA2</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">FA2LegacyInterface</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ZArith_base</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">List</span>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ListNotations</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab208"></a><h1 class="section">Test setup</h1>
<a name="lab209"></a><h2 class="section">Setup parameters</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">token_contract_base_addr</span> : <span class="id" title="var">Address</span> := <span class="id" title="var">addr_of_Z</span> 128.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">lqt_contract_base_addr</span> : <span class="id" title="var">Address</span> := <span class="id" title="var">addr_of_Z</span> 129.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">cpmm_contract_base_addr</span> : <span class="id" title="var">Address</span> := <span class="id" title="var">addr_of_Z</span> 130.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">null_address_</span> : <span class="id" title="var">Address</span> := <span class="id" title="var">creator</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">token_id_</span> : <span class="id" title="var">N</span> := 1.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">initial_lqt</span> : <span class="id" title="var">N</span> := 10.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">initial_tokens</span> : <span class="id" title="var">N</span> := 500.<br/>

<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">TestInfo</span> &lt;: <span class="id" title="var">Dexter2Info</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">accounts</span> := [<span class="id" title="var">person_1</span>; <span class="id" title="var">person_2</span>; <span class="id" title="var">person_3</span>; <span class="id" title="var">person_4</span>; <span class="id" title="var">person_5</span>].<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">gAddr</span> (<span class="id" title="var">c</span> : <span class="id" title="var">Chain</span>) := <span class="id" title="var">elems</span> [<span class="id" title="var">person_1</span>; <span class="id" title="var">person_2</span>; <span class="id" title="var">person_3</span>; <span class="id" title="var">person_4</span>; <span class="id" title="var">person_5</span>].<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">cpmm_contract_addr</span> := <span class="id" title="var">cpmm_contract_base_addr</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">token_contract_addr</span> := <span class="id" title="var">token_contract_base_addr</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">token_id</span> := <span class="id" title="var">token_id_</span>.<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">TestInfo</span>.<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">MG</span> := <span class="id" title="var">Dexter2Gens</span> <span class="id" title="var">TestInfo</span>. <span class="id" title="keyword">Import</span> <span class="id" title="var">MG</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab210"></a><h2 class="section">Setup actions</h2>
 Transfer some coins to each user address 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">transfer_initial_funds</span> := <span class="id" title="var">map</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">addr</span> =&gt; <span class="id" title="var">TestUtils.build_transfer</span> <span class="id" title="var">creator</span> <span class="id" title="var">addr</span> 8) <span class="id" title="var">TestInfo.accounts</span>.<br/>

<br/>
</div>

<div class="doc">
We deploy the token contract with a single token id configured 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">token_setup</span> := {|<br/>
&nbsp;&nbsp;<span class="id" title="var">setup_total_supply</span>        := [(<span class="id" title="var">token_id_</span>, 0%<span class="id" title="var">N</span>)]; <span class="comment">(*&nbsp;Value&nbsp;not&nbsp;used&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">setup_tokens</span>              := <span class="id" title="var">FMap.of_list</span> [(<span class="id" title="var">token_id_</span>, <span class="id" title="var">Build_token_metadata</span> <span class="id" title="var">token_id_</span> 18%<span class="id" title="var">N</span>)];<br/>
&nbsp;&nbsp;<span class="id" title="var">initial_permission_policy</span> := {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">descr_self</span>      := <span class="id" title="var">self_transfer_permitted</span>; <span class="comment">(*&nbsp;Allow&nbsp;self&nbsp;transfers&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">descr_operator</span>  := <span class="id" title="var">operator_transfer_permitted</span>; <span class="comment">(*&nbsp;All&nbsp;operator&nbsp;transfers&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">descr_receiver</span>  := <span class="id" title="var">owner_no_op</span>; <span class="comment">(*&nbsp;Value&nbsp;not&nbsp;used&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">descr_sender</span>    := <span class="id" title="var">owner_no_op</span>; <span class="comment">(*&nbsp;Value&nbsp;not&nbsp;used&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">descr_custom</span>    := <span class="id" title="var">None</span>; <span class="comment">(*&nbsp;Value&nbsp;not&nbsp;used&nbsp;*)</span><br/>
&nbsp;&nbsp;|};<br/>
&nbsp;&nbsp;<span class="id" title="var">transfer_hook_addr_</span>       := <span class="id" title="var">None</span>; <span class="comment">(*&nbsp;No&nbsp;transfer&nbsp;hook&nbsp;configured&nbsp;*)</span><br/>
|}.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">deploy_token</span> := <span class="id" title="var">build_deploy</span> <span class="id" title="var">creator</span> 0 <span class="id" title="var">FA2Token.contract</span> <span class="id" title="var">token_setup</span>.<br/>
</div>

<div class="doc">
Allow CPMM contract to operate on all user accounts' tokens 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">setup_operators</span> := <span class="id" title="var">map</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">addr</span> =&gt; <span class="id" title="var">build_call</span> <span class="id" title="var">addr</span> <span class="id" title="var">token_contract_base_addr</span> 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg_update_operators</span> [<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">add_operator</span> (<span class="id" title="var">Build_operator_param</span> <span class="id" title="var">addr</span> <span class="id" title="var">cpmm_contract_base_addr</span> <span class="id" title="var">all_tokens</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;])<br/>
&nbsp;&nbsp;) <span class="id" title="var">TestInfo.accounts</span>.<br/>
</div>

<div class="doc">
Create tokens in some user accounts 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">create_tokens</span> := <span class="id" title="var">map</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">addr</span> =&gt; <span class="id" title="var">build_call</span> <span class="id" title="var">addr</span> <span class="id" title="var">token_contract_base_addr</span> 1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg_create_tokens</span> <span class="id" title="var">token_id_</span>)<br/>
&nbsp;&nbsp;) [<span class="id" title="var">person_1</span>; <span class="id" title="var">person_2</span>; <span class="id" title="var">person_3</span>].<br/>
</div>

<div class="doc">
Transfer initial token funds to CPMM contract 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">transfer_cpmm_tokens</span> := [<br/>
&nbsp;&nbsp;<span class="id" title="var">build_call</span> <span class="id" title="var">creator</span> <span class="id" title="var">token_contract_base_addr</span> 5 (<span class="id" title="var">msg_create_tokens</span> <span class="id" title="var">token_id_</span>);<br/>
&nbsp;&nbsp;<span class="id" title="var">build_call</span> <span class="id" title="var">creator</span> <span class="id" title="var">token_contract_base_addr</span> 0 (<span class="id" title="var">msg_transfer</span> [{|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">from_</span> := <span class="id" title="var">creator</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">txs</span> := [{|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">to_</span> := <span class="id" title="var">cpmm_contract_base_addr</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">dst_token_id</span> := <span class="id" title="var">token_id_</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">amount</span> := 500%<span class="id" title="var">N</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|}];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">sender_callback_addr</span> := <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;|}])<br/>
].<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">setup_token_contract</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">deploy_token</span> ::<br/>
&nbsp;&nbsp;<span class="id" title="var">setup_operators</span> ++<br/>
&nbsp;&nbsp;<span class="id" title="var">create_tokens</span> ++<br/>
&nbsp;&nbsp;<span class="id" title="var">transfer_cpmm_tokens</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">lqt_setup</span> := {|<br/>
&nbsp;&nbsp;<span class="id" title="var">admin_</span>        := <span class="id" title="var">cpmm_contract_base_addr</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">lqt_provider</span>  := <span class="id" title="var">null_address_</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">initial_pool</span>  := <span class="id" title="var">initial_lqt</span><br/>
|}.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">deploy_lqt</span> := [<span class="id" title="var">build_deploy</span> <span class="id" title="var">creator</span> 0 <span class="id" title="var">DEX2LQT.contract</span> <span class="id" title="var">lqt_setup</span>].<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">cpmm_setup</span> := {|<br/>
&nbsp;&nbsp;<span class="id" title="var">lqtTotal_</span>     := <span class="id" title="var">initial_lqt</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">manager_</span>      := <span class="id" title="var">null_address_</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">tokenAddress_</span> := <span class="id" title="var">token_contract_base_addr</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">tokenId_</span>      := <span class="id" title="var">token_id_</span><br/>
|}.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">deploy_cpmm</span> := <span class="id" title="var">build_deploy</span> <span class="id" title="var">creator</span> 0 <span class="id" title="var">DEX2.contract</span> <span class="id" title="var">cpmm_setup</span>.<br/>
</div>

<div class="doc">
Transfer some tez to CPMM contract 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">transfer_cpmm_xtz</span> := <span class="id" title="var">TestUtils.build_transfer</span> <span class="id" title="var">creator</span> <span class="id" title="var">cpmm_contract_base_addr</span> 5.<br/>
</div>

<div class="doc">
Connect CPMM and Lqt token contracts 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_lqt_address</span> := <span class="id" title="var">build_call</span> <span class="id" title="var">creator</span> <span class="id" title="var">cpmm_contract_base_addr</span> 0<br/>
&nbsp;&nbsp;(@<span class="id" title="var">FA2Token.other_msg</span> <span class="id" title="var">_</span> <span class="id" title="var">DexterMsg</span> (<span class="id" title="var">SetLqtAddress</span> <span class="id" title="var">lqt_contract_base_addr</span>)).<br/>
</div>

<div class="doc">
Sync token pool counter 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">update_token_pool</span> := <span class="id" title="var">build_call</span> <span class="id" title="var">creator</span> <span class="id" title="var">cpmm_contract_base_addr</span> 0<br/>
&nbsp;&nbsp;(@<span class="id" title="var">FA2Token.other_msg</span> <span class="id" title="var">_</span> <span class="id" title="var">DexterMsg</span> <span class="id" title="var">UpdateTokenPool</span>).<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">setup_cpmm_contract</span> := [<br/>
&nbsp;&nbsp;<span class="id" title="var">deploy_cpmm</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">transfer_cpmm_xtz</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">set_lqt_address</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">update_token_pool</span><br/>
].<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_cb</span> :=<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">add_block</span> <span class="id" title="var">empty_chain</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">transfer_initial_funds</span> ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">setup_token_contract</span> ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">deploy_lqt</span> ++<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">setup_cpmm_contract</span>).<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_cb'</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">init_cb</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Ok</span> <span class="id" title="var">cb</span> =&gt; <span class="id" title="var">cb</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Err</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">empty_chain</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">NotationInfo</span> &lt;: <span class="id" title="var">TestNotationParameters</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">gAction</span> := <span class="id" title="var">gAction</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_cb</span> := <span class="id" title="var">init_cb'</span>.<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">NotationInfo</span>.<br/>
<span class="id" title="keyword">Module</span> <span class="id" title="var">TN</span> := <span class="id" title="var">TestNotations</span> <span class="id" title="var">NotationInfo</span>. <span class="id" title="keyword">Import</span> <span class="id" title="var">TN</span>.<br/>
<span class="comment">(*&nbsp;Sample&nbsp;(gChain).&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
<a name="lab211"></a><h1 class="section">Tests</h1>
 Dexter2 uses call to balance_of entrypoint on the token contract
    to sync the token reserves. It is key that there is no way for an
    attacker to manipulate the reserve by interfering with this sync.
    Therefore we test in both execution orders that there will never be
    callbacks with someone elses balance / incorrect balance.

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">msg_is_balance_of_callback</span> (<span class="id" title="var">cstate</span> : <span class="id" title="var">Dexter2CPMM.State</span>) (<span class="id" title="var">msg</span> : <span class="id" title="var">Dexter2CPMM.Msg</span>) : <span class="id" title="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">msg</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FA2Token.receive_balance_of_param</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">callback_safe</span> (<span class="id" title="var">env</span> : <span class="id" title="var">Environment</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">old_state</span> : <span class="id" title="var">Dexter2CPMM.State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Dexter2CPMM.Msg</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">Dexter2CPMM.State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> (<span class="id" title="var">new_state</span>, <span class="id" title="var">_</span>), <span class="id" title="var">FA2Token.receive_balance_of_param</span> <span class="id" title="var">responses</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">length_correct</span> := <span class="id" title="var">length</span> <span class="id" title="var">responses</span> =? 1 <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">owner_correct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">responses</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">h</span> :: <span class="id" title="var">t</span> =&gt; <span class="id" title="var">address_eqb</span> (<span class="id" title="var">h</span>.(<span class="id" title="var">request</span>).(<span class="id" title="var">owner</span>)) <span class="id" title="var">cpmm_contract_base_addr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">amount_correct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">responses</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">h</span> :: <span class="id" title="var">t</span> =&gt; (<span class="id" title="var">old_state</span>.(<span class="id" title="var">tokenPool</span>) &lt;=? <span class="id" title="var">h</span>.(<span class="id" title="var">balance</span>))%<span class="id" title="var">N</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">is_updating</span> := <span class="id" title="var">old_state</span>.(<span class="id" title="var">selfIsUpdatingTokenPool</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">checker</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">length_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">owner_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">amount_correct</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">is_updating</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;))<br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="comment">(*&nbsp;Extract&nbsp;Constant&nbsp;DepthFirst&nbsp;=&gt;&nbsp;"false".<br/>
QuickChick&nbsp;({{msg_is_balance_of_callback}}&nbsp;cpmm_contract_base_addr&nbsp;{{callback_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Extract&nbsp;Constant&nbsp;DepthFirst&nbsp;=&gt;&nbsp;"true".<br/>
QuickChick&nbsp;({{msg_is_balance_of_callback}}&nbsp;cpmm_contract_base_addr&nbsp;{{callback_safe}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
Next we test that no Dexter operations can happen
    while token reserve is syncing.
    Again we test for both execution models.

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">is_syncing</span> (<span class="id" title="var">state</span> : <span class="id" title="var">Dexter2CPMM.State</span>) (<span class="id" title="var">msg</span> : <span class="id" title="var">Dexter2CPMM.Msg</span>) : <span class="id" title="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">state</span>.(<span class="id" title="var">selfIsUpdatingTokenPool</span>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">only_callbacks</span> (<span class="id" title="var">env</span> : <span class="id" title="var">Environment</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cctx</span> : <span class="id" title="var">ContractCallContext</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">old_state</span> : <span class="id" title="var">Dexter2CPMM.State</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">Dexter2CPMM.Msg</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">result_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">Dexter2CPMM.State</span> * <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> (<span class="id" title="var">result_opt</span>, <span class="id" title="var">msg</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| (<span class="id" title="var">Some</span> <span class="id" title="var">_</span>, <span class="id" title="var">FA2Token.receive_balance_of_param</span> <span class="id" title="var">_</span>) =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="comment">(*&nbsp;Extract&nbsp;Constant&nbsp;DepthFirst&nbsp;=&gt;&nbsp;"false".<br/>
QuickChick&nbsp;({{is_syncing}}&nbsp;cpmm_contract_base_addr&nbsp;{{only_callbacks}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Extract&nbsp;Constant&nbsp;DepthFirst&nbsp;=&gt;&nbsp;"true".<br/>
QuickChick&nbsp;({{is_syncing}}&nbsp;cpmm_contract_base_addr&nbsp;{{only_callbacks}}).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
Finally we test that the token reserve invariant holds.
    That is the actual token balance should always be less
    than the token reserve.

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">token_reserve_safe</span> (<span class="id" title="var">cs</span> : <span class="id" title="var">ChainState</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">Dexter2CPMM.State</span> <span class="id" title="var">cs</span> <span class="id" title="var">cpmm_contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">dexter_state</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">get_contract_state</span> <span class="id" title="var">FA2Token.State</span> <span class="id" title="var">cs</span> <span class="id" title="var">token_contract_base_addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">token_state</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">token_reserve</span> := <span class="id" title="var">dexter_state</span>.(<span class="id" title="var">tokenPool</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">token_balance</span> := <span class="id" title="var">address_balance</span> <span class="id" title="var">dexter_state</span>.(<span class="id" title="var">tokenId</span>) <span class="id" title="var">cpmm_contract_base_addr</span> <span class="id" title="var">token_state</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">checker</span> (<span class="id" title="var">token_reserve</span> &lt;=? <span class="id" title="var">token_balance</span>)%<span class="id" title="var">N</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">checker</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="comment">(*&nbsp;Extract&nbsp;Constant&nbsp;DepthFirst&nbsp;=&gt;&nbsp;"false".<br/>
QuickChick&nbsp;(forAllBlocks&nbsp;token_reserve_safe).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>

<br/>
<span class="comment">(*&nbsp;Extract&nbsp;Constant&nbsp;DepthFirst&nbsp;=&gt;&nbsp;"true".<br/>
QuickChick&nbsp;(forAllBlocks&nbsp;token_reserve_safe).&nbsp;*)</span><br/>
<span class="comment">(*&nbsp;+++&nbsp;Passed&nbsp;10000&nbsp;tests&nbsp;(0&nbsp;discards)&nbsp;*)</span><br/>
</div>
</div>
<div id="footer">
  Generated by <a href="https://coq.inria.fr/">coqdoc</a> and improved with <a href="https://github.com/tebbi/coqdocjs">CoqdocJS</a> and <a href="https://github.com/jgallen23/toc">TOC</a>
</div>
</div>
<script>
  const elements = document.getElementsByClassName("libtitle");
  while(elements.length > 0){
        elements[0].parentNode.removeChild(elements[0]);
  }
  if (window.location.pathname.endsWith("/toc.html")) {
      const jstocDiv = document.getElementById("js-toc");
      jstocDiv.classList.remove("toc");
      jstocDiv.classList.add("jstoc-hidden");
      const jstocHeaderDiv = document.getElementById("js-toc-header");
      jstocHeaderDiv.classList.add("jstoc-hidden");
  }
  console.log(window.location.pathname);
</script>
<script type="text/javascript" src="toc.js"></script>
</body>

</html>
